

### 다중 코어 환경에서 발생하는 Race Condition 문제

- 이 문제를 방지하려면 동기화가 필수적이다. 
- 뮤텍스나 세마포어 같은 동기화를 구현하기 위해서는 하드웨어 수준의 지원이 필요. 

- 현대 CPU는 분리 불가능한 연산으로 수행하는 특별한 원자적 명령어를 제공한다. 

#### 명령어 1 : Test-and-Set(TS), 

- 메모리 위치의 값을 읽고 True 로 설정. 
- 이전 값을 반환해서 스핀 락같은 뮤텍스 구현에 사용
- 단순하게 내가 쓰기 시작할때 true 로 바꿔버림. 그러면 다른 CPU는 접근할 수 없음. 
- 그리고 나서 다 작업 했으면 false 로 바꿔서 자원을 풀어주기 Lock 개념인데? 

#### 명령어 2 : Compare-and-Swap (CAS)

- TS 는 들어가면 무조껀 true 로 설정했는데 CAS 는 한번 검증과정이 있음
- 내가 원하는 메모리가 맞는지 예상 값과 비교를 해보고 일치하면 true 로 바꾸고 처리. 
- 다 처리했으면 false 로 바꾸던가 여기서 다양한 처리를 할 수 있다고 함.
- 그래서 범용적이라고 함. 



### 메모리 일관성과 `volatile` 키워드

- 동시성 프로그래밍에서 발생하는 버그의 대부분 컴파일러와 CPU가 수행하는 과한 최적화에서 온다. 
- 이런 최적화들을 제어하기위한 장치를 말함. 

#### 어떨때 최적화가 문제일까?

- 실행에 영향을 주지 않는 선에서 명령어의 순서를 재배치 할 수 있음. 
- 현대 CPU 자체에서도 명령어들을 프로그램 순서와 다르게 처리해서 효율을 높인다고함. 
- 단일 스레드면 문제가 없는데 이때 여러 스레드가 공유변수를 사용하면 문제가 생김 

### 그래서 valatile 는 뭐하는데?

- 특정 변수의 값이 언제든지 외부 요인에 의해 변경될 수 있다고 알려주는 지시어임. 
- 그러면 이 지시를 받은놈들은 컴파일러가 특정 최적화를 진행하지 않음. 

- 약간 이거 관심병사니까 함부로 막 하지마! 라고 알려주는 느낌으로 이해.
- 단순히 최적화를 막는 작업이지 막 동기화를 해주고 그런놈이 아니다. 
	- 원자적 명령어 TS, CAS 등이 동기화 

### 멀티코어일떄 동기화는??

- 각 코어가 독립적인 캐시를 가지고 있기 때문에 메모리 일관성 문제가 생긴다. 

- 하드웨어
	- 원자적 명령어
- 소프트웨어
	- 스핀락, 뮤텍스 등으로 임계구역 보호.
	- 필요하다면 메모리 베리어를 사용해서 순서를 강제한다. 