
### ThreadLocal 이란?

- 자바에서 스레드마다 독립적인 변수를 저장할 수 있도록 지원해주는 클래스 
- 여러 스레드가 같은 변수를 공유하는 동시성 문제를 해결할 수 있다. 
- 스레드 별로 별도의 저장소를 가지고있어 자신만의 값을 가진다. 

| 구분     | ThreadLocal                | [[스레드풀(Thread Pool)]]               |
| ------ | -------------------------- | ----------------------------------- |
| 역할     | 각 스레드별 독립적인 변수 저장소 제공      | 여러 작업(태스크)을 실행하기 위해 스레드 미리 생성 및 재사용 |
| 목적     | 스레드 간 데이터 격리와 동시성 문제 해결    | 스레드 생성 비용 절감 및 효율적인 작업 처리           |
| 데이터 관리 | 스레드 내부에 값 저장 (스레드별 데이터 유지) | 스레드 자체를 재사용하여 여러 작업 처리              |
| 주의점    | 스레드풀에서 재사용되는 스레드에 값 잔류 위험  | 작업이 끝나면 스레드가 재사용됨, 관리 필요            |


### 사용하는 예시들

- **트랜잭션 동기화 관리 (TransactionSynchronizationManager)**  
    스프링에서 데이터베이스 트랜잭션 처리를 할 때, 트랜잭션 상태나 리소스를 스레드별로 안전하게 관리해야 합니다.  
    이때, ThreadLocal을 사용해서 “현재 스레드가 처리 중인 트랜잭션 정보”를 저장하고, 다른 스레드와 섞이지 않도록 합니다.
    
- **사용자 인증 정보 관리 (SecurityContextHolder)**  
    보안 인증 정보를 스레드별로 저장할 때 쓰입니다. 예를 들어, 로그인한 사용자의 정보가 여러 스레드에 섞이지 않도록 하기 위해 ThreadLocal에 저장합니다.  
    그래서 현재 요청을 처리하는 스레드에서는 본인의 인증 정보를 안전하게 참조할 수 있습니다.
    
- **웹 요청 정보 관리 (RequestContextHolder)**  
    HTTP 요청에 관련된 데이터를 스레드별로 관리할 때 사용됩니다.  
    예를 들어, 한 사용자의 요청을 처리하는 동안 그 요청에 대한 부가 정보를 ThreadLocal에 저장해 놓고, 해당 스레드에서만 접근하게 하는 방식입니다

### 장점

- 스레드 간 값이 격리되어 안전하다.
- 동기화를 사용하지 않나도 된다. 원래 보통 같은 데이터를 쓸 때는 락을 걸어 충돌을 막는데 이 경우에 성능이 떨어진다. 

### 주의할점

- 스레드 풀과 함께 쓸 떄 주의해야한다. 
- 스레드 풀은 미리 만들어 둔 스레드를 여러 작업에 재사용한다. 
- 이때 ThreadLocal 에 저장한 값이 스레드에 남아있을 수 있다. 
- 그래서 작업이 끝날때 ThreadLocal.remove() 를 꼭 해줘야 한다고 한다. 


## **NamedThreadLocal**

- Spring에서 제공하는 ThreadLocal의 확장판입니다.
- 이름을 붙일 수 있어서, 여러 ThreadLocal을 사용할 때 어떤 것이 어떤 목적의 변수인지 쉽게 알 수 있습니다.
- 주로 디버깅할 때 유용하며, 기본 ThreadLocal과 기능은 동일합니다.