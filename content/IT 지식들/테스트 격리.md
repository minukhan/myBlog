
## 테스트 격리

- 각 테스트가 서로 독립적으로 실행되도록 보장하는 것을 말한다. 
- 어떤 테스트가 실행되더라도 다른 테스트의 결과나 상태에 영향을 주거나 받지 않아야 한다.


### 비 결정적 테스트란?

- 같은 테스트를 진행했을때 같은 결과가 아니라 다른 결과가 나오는 테스트.
- 예시로 데이터베이스와 같은 공유자원에 의존할 경우에 성공, 실패 결과가 달라질 수 있다. 
- 이때 코드의 문제인지, 비 결정적 요인때문인지 판단하기 어려워진다.

=> 따라서 테스트가 항상 동일한 조건에서 예측 가능한 결과를 낼 수 있도록 격리하는게 중요하다. 
## Spring 테스트에서 데이터베이스 격리 방법 3가지

| 방법                      | 설명                           | 장점          | 단점                        |
| ----------------------- | ---------------------------- | ----------- | ------------------------- |
| `@DirtiesContext`       | 테스트마다 애플리케이션 컨텍스트를 새로 로딩     | 완전한 격리      | 느림, 컨텍스트 캐시 무효화           |
| `@Sql("/truncate.sql")` | 테스트 전/후 SQL로 테이블 초기화         | 빠름, 명확한 제어  | 유지보수 어려움 (테이블 추가 시 직접 수정) |
| `@Transactional`        | 테스트 트랜잭션 시작 후 테스트 종료 시 자동 롤백 | 빠름, 유지보수 쉬움 | 일부 상황에서 트랜잭션 격리 실패 가능     |
## 상황별 추천 전략

|테스트 종류|추천 격리 방식|이유|
|---|---|---|
|단순 서비스/레포지토리 테스트|`@Transactional`|빠르고 편리, 기본적으로 안전|
|컨트롤러/실제 서버 구동 테스트|`@Sql`, `@DirtiesContext`, 또는 `Testcontainers`|스레드 분리로 인해 트랜잭션 격리 불가|
|`@Async`, `REQUIRES_NEW` 포함 테스트|명시적 정리 로직, `@Sql` 등|트랜잭션 롤백 적용되지 않음|

>[!important] 정리
>
>@Transactional 은 효율적이고 많이 사용된다. 
>하지만 트랜잭션 경계를 벗어나는 코드(비동기, 웹 환경) 에서는 격리보장이 되지 않는다. 
>그래서 상황에 맞게 @sql, @DirtiesContext 를 병행해서 사용해야한다. 